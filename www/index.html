<!DOCTYPE html>
<html>
<head>
	<script type="text/javascript" src="http://chat.mudz.me/server/socket.io.js"></script>
	<script type="text/javascript" src="js/crypto.js"></script>
	<script type="text/javascript">

	function launch()
	{
		var socket = io.connect("ws://chat.mudz.me/", { resource: "server" });
		socket.on("error", function(e)
		{
			console.log("ERROR");
			console.log(e);
		});
		socket.on("connect", function()
		{
			socket.on("challenge", function(challenge)
			{
				var password = "Yeah, I'm not committing my real password...";

				var bits = password.split("");
				var offset = 0;

				for(var i = 0; i < bits.length; i++)
				{
					var v = bits[i].charCodeAt(0);
					if((i % 5) == 4)
						offset = offset / v;
					else if((i % 5) == 0 || (i % 5) == 3)
						offset += v;
					else
						offset *= v;
				}
				offset = Math.round(offset);

				var hpass = SHA256(password);

				for(var i = 0; i < challenge.salt.length; i++)
				{
					var uc = challenge.salt.substr(i, 1);
					var pos = offset % hpass.length;
					hpass = hpass.substr(0, pos) + uc + hpass.substring(pos);
					offset -= pos;
				}

				var key = SHA256(hpass);

				challenge = challenge.challenge;
				var plaintext = CryptoJS.AES.decrypt(challenge, key, { format: JsonFormatter}).toString(CryptoJS.enc.Utf8);

				var response = plaintext.split("").reverse().join("");
				response = CryptoJS.AES.encrypt(response, key, { format: JsonFormatter }).toString();

				socket.emit("authenticate", { username: "darkcooger", response: response });
			});

			socket.emit("challenge", { username: "darkcooger" });
		});
		socket.on("disconnect", function(d)
		{
			console.log("DISCONNECT");
			console.log(d);
		});
	}

	</script>
</head>
<body onload="launch()">
</body>
</html>
